<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JobReach — Admin Panel</title>
  <style>
    :root {
      --bg0: #0a0610;
      --bg1: #120b1d;
      --card: rgba(255, 255, 255, 0.07);
      --card2: rgba(255, 255, 255, 0.04);
      --stroke: rgba(255, 90, 122, 0.2);
      --stroke2: rgba(255, 255, 255, 0.1);
      --text: rgba(255, 255, 255, 0.92);
      --muted: rgba(255, 255, 255, 0.6);
      --accent: #ff5a7a;
      --accent2: #ff9a5c;
      --green: #34d399;
      --green-bg: rgba(52, 211, 153, 0.12);
      --red: #ff5a7a;
      --red-bg: rgba(255, 90, 122, 0.12);
      --yellow: #fbbf24;
      --yellow-bg: rgba(251, 191, 36, 0.12);
      --blue: #60a5fa;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --radius: 16px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    * {
      box-sizing: border-box;
      margin: 0;
    }

    body {
      font-family: var(--sans);
      color: var(--text);
      background: radial-gradient(1200px 900px at 20% 10%, rgba(255, 90, 122, 0.1), transparent 60%),
        radial-gradient(900px 700px at 80% 30%, rgba(255, 154, 92, 0.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
      padding: 0;
    }

    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      font-size: 20px;
      background: linear-gradient(135deg, rgba(255, 90, 122, 0.9), rgba(255, 154, 92, 0.8));
    }

    .brand-title {
      font-size: 20px;
      font-weight: 780;
    }

    .brand-sub {
      font-size: 12px;
      color: var(--accent2);
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* Buttons */
    .btn {
      border: none;
      border-radius: 10px;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
    }

    .btn:hover {
      opacity: 0.88;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #0a0610;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      border: 1px solid var(--stroke2);
    }

    .btn-danger {
      background: var(--red-bg);
      color: var(--red);
      border: 1px solid rgba(255, 90, 122, 0.3);
    }

    .btn-success {
      background: var(--green-bg);
      color: var(--green);
      border: 1px solid rgba(52, 211, 153, 0.3);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--card);
      border: 1px solid var(--stroke2);
      border-radius: var(--radius);
      padding: 18px;
      backdrop-filter: blur(8px);
    }

    .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 800;
    }

    .stat-value.green {
      color: var(--green);
    }

    .stat-value.red {
      color: var(--red);
    }

    .stat-value.blue {
      color: var(--blue);
    }

    .stat-value.yellow {
      color: var(--yellow);
    }

    /* Card */
    .card {
      background: var(--card);
      border: 1px solid var(--stroke2);
      border-radius: var(--radius);
      padding: 24px;
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .card-hint {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 18px;
    }

    /* Table */
    .table-wrap {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead th {
      text-align: left;
      padding: 10px 12px;
      color: var(--muted);
      border-bottom: 1px solid var(--stroke2);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    tbody td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      vertical-align: middle;
    }

    tbody tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    .badge-active {
      background: var(--green-bg);
      color: var(--green);
      border: 1px solid rgba(52, 211, 153, 0.25);
    }

    .badge-banned {
      background: var(--red-bg);
      color: var(--red);
      border: 1px solid rgba(255, 90, 122, 0.25);
    }

    .badge-admin {
      background: rgba(251, 191, 36, 0.12);
      color: var(--yellow);
      border: 1px solid rgba(251, 191, 36, 0.25);
    }

    .badge-user {
      background: rgba(96, 165, 250, 0.12);
      color: var(--blue);
      border: 1px solid rgba(96, 165, 250, 0.25);
    }

    /* Action buttons in table */
    .action-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      place-items: center;
    }

    .modal-overlay.active {
      display: grid;
    }

    .modal {
      background: #1a1025;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 28px;
      width: min(420px, 92vw);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    }

    .modal-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .modal-user {
      color: var(--accent2);
      font-size: 13px;
      margin-bottom: 16px;
    }

    .modal label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin: 12px 0 6px;
    }

    .modal input[type="number"] {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--stroke2);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
      font-size: 14px;
    }

    .modal input[type="number"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(255, 90, 122, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    /* Status message */
    .status-msg {
      margin-top: 16px;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      display: none;
    }

    .status-msg.show {
      display: block;
    }

    .status-msg.good {
      background: var(--green-bg);
      color: var(--green);
      border: 1px solid rgba(52, 211, 153, 0.25);
    }

    .status-msg.bad {
      background: var(--red-bg);
      color: var(--red);
      border: 1px solid rgba(255, 90, 122, 0.25);
    }

    /* Loading spinner */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid var(--stroke2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
  </style>
</head>

<body>
  <div class="shell">
    <!-- Header -->
    <header class="header">
      <div class="brand">
        <div class="logo">🛡️</div>
        <div>
          <div class="brand-title">JobReach Admin</div>
          <div class="brand-sub">User Management & Controls</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary btn-sm" id="refreshBtn">🔄 Refresh</button>
        <button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>
      </div>
    </header>

    <!-- Stats -->
    <div class="stats" id="statsRow">
      <div class="stat-card">
        <div class="stat-label">Total Users</div>
        <div class="stat-value blue" id="statTotal">—</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Users</div>
        <div class="stat-value green" id="statActive">—</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Banned Users</div>
        <div class="stat-value red" id="statBanned">—</div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="card">
      <div class="card-title">Registered Users</div>
      <div class="card-hint">Manage user accounts, set limits, and ban/unban users.</div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Role</th>
              <th>Status</th>
              <th>Created</th>
              <th>Usage (Day)</th>
              <th>Limits (Day)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr>
              <td colspan="7" class="loading">
                <div class="spinner"></div><br>Loading users…
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="status-msg" id="statusMsg"></div>
    </div>
  </div>

  <!-- Edit Limits Modal -->
  <div class="modal-overlay" id="limitsModal">
    <div class="modal">
      <div class="modal-title">Edit User Limits</div>
      <div class="modal-user" id="modalUser"></div>

      <label for="modalDailyEmails">Daily Emails Limit</label>
      <input type="number" id="modalDailyEmails" min="0" max="1000" />

      <label for="modalDailyResumes">Daily Resumes Limit</label>
      <input type="number" id="modalDailyResumes" min="0" max="100" />

      <div class="modal-actions">
        <button class="btn btn-primary" id="saveLimitsBtn">Save Limits</button>
        <button class="btn btn-secondary" id="cancelLimitsBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // --- State ---
    let allUsers = [];
    let editingUser = null;

    // --- DOM ---
    const tbody = document.getElementById("usersTableBody");
    const statusMsg = document.getElementById("statusMsg");
    const limitsModal = document.getElementById("limitsModal");

    // --- Helpers ---
    function esc(s) {
      const d = document.createElement("div");
      d.textContent = String(s || "");
      return d.innerHTML;
    }

    function showStatus(type, msg) {
      statusMsg.className = `status-msg show ${type}`;
      statusMsg.textContent = msg;
      setTimeout(() => { statusMsg.classList.remove("show"); }, 4000);
    }

    function formatDate(iso) {
      if (!iso || iso === "unknown") return "—";
      try {
        const d = new Date(iso);
        return d.toLocaleDateString("en-IN", { day: "2-digit", month: "short", year: "numeric" });
      } catch { return iso; }
    }

    // --- API ---
    async function apiFetch(url, opts = {}) {
      const res = await fetch(url, {
        headers: { "Content-Type": "application/json" },
        ...opts,
        body: opts.body ? JSON.stringify(opts.body) : undefined,
      });
      const data = await res.json().catch(() => ({}));
      if (res.status === 403 && (data.error || "").includes("Admin")) {
        window.location.href = "/admin-login.html";
        throw new Error("Admin session expired");
      }
      return { res, data };
    }

    // --- Load Users ---
    async function loadUsers() {
      try {
        tbody.innerHTML = `<tr><td colspan="7" class="loading"><div class="spinner"></div><br>Loading…</td></tr>`;
        const { res, data } = await apiFetch("/api/admin/users");
        if (!res.ok || !data.ok) throw new Error(data.error || "Failed to load users");
        allUsers = data.users || [];
        renderStats();
        renderTable();
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="7" style="color:var(--red);padding:20px">${esc(e.message)}</td></tr>`;
      }
    }

    function renderStats() {
      const total = allUsers.length;
      const banned = allUsers.filter(u => u.banned).length;
      const active = total - banned;
      document.getElementById("statTotal").textContent = total;
      document.getElementById("statActive").textContent = active;
      document.getElementById("statBanned").textContent = banned;
    }

    function renderTable() {
      if (!allUsers.length) {
        tbody.innerHTML = `<tr><td colspan="7" style="color:var(--muted);padding:20px;text-align:center">No users registered yet.</td></tr>`;
        return;
      }

      tbody.innerHTML = allUsers.map(u => {
        const statusBadge = u.banned
          ? `<span class="badge badge-banned">🚫 Banned</span>`
          : `<span class="badge badge-active">✅ Active</span>`;
        const roleBadge = u.role === "admin"
          ? `<span class="badge badge-admin">Admin</span>`
          : `<span class="badge badge-user">User</span>`;
        const usage = u.usage || {};
        const limits = u.limits || {};

        return `<tr>
          <td><strong>${esc(u.username)}</strong></td>
          <td>${roleBadge}</td>
          <td>${statusBadge}</td>
          <td style="color:var(--muted)">${formatDate(u.created)}</td>
          <td>
            <span style="font-size:12px">📧 ${usage.dailyCount || 0}</span>
          </td>
          <td>
            <span style="font-size:12px">📧 ${limits.dailyEmails || 50} / 📄 ${limits.dailyResumes || 10}</span>
          </td>
          <td>
            <div class="action-group">
              ${u.banned
            ? `<button class="btn btn-success btn-sm" onclick="unbanUser('${esc(u.username)}')">Unban</button>`
            : `<button class="btn btn-danger btn-sm" onclick="banUser('${esc(u.username)}')">Ban</button>`
          }
              <button class="btn btn-secondary btn-sm" onclick="openLimitsModal('${esc(u.username)}')">⚙️ Limits</button>
              <button class="btn btn-danger btn-sm" onclick="deleteUser('${esc(u.username)}')">🗑️</button>
            </div>
          </td>
        </tr>`;
      }).join("");
    }

    // --- Ban / Unban ---
    async function banUser(username) {
      if (!confirm(`Ban user "${username}"? They will be immediately logged out and unable to login.`)) return;
      try {
        const { res, data } = await apiFetch("/api/admin/ban", { method: "POST", body: { username } });
        if (!res.ok || !data.ok) throw new Error(data.error || "Ban failed");
        showStatus("good", data.message || `${username} banned`);
        await loadUsers();
      } catch (e) {
        showStatus("bad", e.message);
      }
    }

    async function unbanUser(username) {
      try {
        const { res, data } = await apiFetch("/api/admin/unban", { method: "POST", body: { username } });
        if (!res.ok || !data.ok) throw new Error(data.error || "Unban failed");
        showStatus("good", data.message || `${username} unbanned`);
        await loadUsers();
      } catch (e) {
        showStatus("bad", e.message);
      }
    }

    // --- Delete ---
    async function deleteUser(username) {
      if (!confirm(`🗑️ DELETE user "${username}"?\n\nThis action cannot be undone!`)) return;
      try {
        const { res, data } = await apiFetch(`/api/admin/user/${encodeURIComponent(username)}`, { method: "DELETE" });
        if (!res.ok || !data.ok) throw new Error(data.error || "Delete failed");
        showStatus("good", data.message || `${username} deleted`);
        await loadUsers();
      } catch (e) {
        showStatus("bad", e.message);
      }
    }

    // --- Limits Modal ---
    function openLimitsModal(username) {
      editingUser = username;
      const user = allUsers.find(u => u.username === username);
      const limits = user?.limits || {};
      document.getElementById("modalUser").textContent = `User: ${username}`;
      document.getElementById("modalDailyEmails").value = limits.dailyEmails || 50;
      document.getElementById("modalDailyResumes").value = limits.dailyResumes || 10;
      limitsModal.classList.add("active");
    }

    document.getElementById("cancelLimitsBtn").addEventListener("click", () => {
      limitsModal.classList.remove("active");
      editingUser = null;
    });

    limitsModal.addEventListener("click", (e) => {
      if (e.target === limitsModal) {
        limitsModal.classList.remove("active");
        editingUser = null;
      }
    });

    document.getElementById("saveLimitsBtn").addEventListener("click", async () => {
      if (!editingUser) return;
      const dailyEmails = Number(document.getElementById("modalDailyEmails").value) || 50;
      const dailyResumes = Number(document.getElementById("modalDailyResumes").value) || 10;
      try {
        const { res, data } = await apiFetch("/api/admin/limits", {
          method: "POST",
          body: { username: editingUser, dailyEmails, dailyResumes }
        });
        if (!res.ok || !data.ok) throw new Error(data.error || "Save limits failed");
        limitsModal.classList.remove("active");
        showStatus("good", data.message || "Limits updated");
        editingUser = null;
        await loadUsers();
      } catch (e) {
        showStatus("bad", e.message);
      }
    });

    // --- Logout ---
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try { await fetch("/api/admin/logout", { method: "POST" }); } catch { }
      window.location.href = "/admin-login.html";
    });

    // --- Refresh ---
    document.getElementById("refreshBtn").addEventListener("click", loadUsers);

    // --- Init ---
    loadUsers();
  </script>
</body>

</html>